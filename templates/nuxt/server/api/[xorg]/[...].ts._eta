/**
 * This file was automatically generated by simpleapp generator. Every
 * --remove-this-line-to-prevent-override--
 * last change 2024-02-23
 * Author: Ks Tan
 */

 
import axios, { AxiosRequestConfig } from 'axios';
import { getServerSession } from '#auth'
import type { Session } from 'next-auth';
import * as fs from 'fs'
export default defineEventHandler(async (event:any) => {
    type additionalprops = {accessToken?:string} 
    let session:any=null
    
    
    try {
        session = await getServerSession(event)
        
    } catch (error) {
        throw createError({ statusText: 'Unauthorized', status: 302 })
    }
    if(!session) {
       throw createError({ statusText: 'Unauthorized', status: 302 })
    }

    return new Promise<any>(async (resolve, reject) => {       
        const xOrg = event.context.params?.xorg ?? ''
        const documentLink = event.context.params?._ ?? ''
        const accessToken = session?.accessToken;
        

        let forwardData: any = {};
        const req = event.node.req;
        let bodydata: any
        let querydata:any
        querydata = getQuery(event);
        if(req.method == 'POST' || req.method == 'PUT' || req.method == 'PATCH' ) {
            bodydata = await readBody(event);
        } 


        const frontEndRes = event.node.res;
        const url = process.env.SIMPLEAPP_BACKEND_URL + '/' + documentLink;
        const axiosConfig: AxiosRequestConfig = {
            method: req.method,
            url: url,
            headers: {
                Authorization: `Bearer ${accessToken}`,
                'X-Org': xOrg,
            },
            data: bodydata,
            params: querydata,
        }
        
        try{            
            const res =  await axios(axiosConfig)
            if (res.headers['content-type'] === 'image/png') {
                frontEndRes.setHeader('Content-Type', 'image/png');
                frontEndRes.setHeader('Content-Disposition', 'inline');
                frontEndRes.end(Buffer.from(res.data, 'binary'));
            }else if(documentLink.includes('images/')){
                // console.log(documentLink," Resdata of base64 photo",res.data.length)
                let imageData
                frontEndRes.setHeader('Content-Type', 'image/png');
                
                // console.log("load image for",documentLink)
                if( res.data.length){
                    console.log("obtain base64 from server length:",res.data.length)
                    imageData = base64ToBuffer(res.data);
                    
                }else{
                    // console.log("server no image, use default image")
                    const folder = 'assets/images/'
                    let filename = filename='unknown.png';
                    const fullpath = folder+filename;
                    if(fs.existsSync(fullpath)){
                        imageData = fs.readFileSync(fullpath)
                    }else{
                        console.log(fullpath,'does not exists')
                    }                    
                }
                 frontEndRes.end(Buffer.from(imageData, 'binary'));                                
                
            }else{
                frontEndRes.statusCode = res.status;
                if(res.statusText) {
                    frontEndRes.statusMessage = res.statusText;
                }
                resolve(res.data);
            }
        }catch(error){
            if(!error?.response){
                console.log("backend server no response ",error.code)              
                reject({ 
                    statusMessage:"backendServerDownMessage",
                    statusCode: 503,                    
                });            
            }else if (error.response.status == 401) {
                return sendRedirect(event, '/login', 302)             
            }else{
                const responseCode = error.response.data?.statusCode ? error.response.data.statusCode : error.response.status 
                const responseMsg = error.response.data ? error.response.data.message : error.response.statusText 
                // reject(error.data)
                // console.log("----error.response.data--",responseMsg,error.response.data,error.response.status,responseCode)
                reject({ 
                    statusMessage: responseMsg, 
                    statusCode: responseCode ,
                    data: error.response.data
                });         
                
            }
        }
    })
    
})



function base64ToBuffer(base64String:string) {
    // Split the base64 string into parts
    const parts = base64String.split(',');
    const contentType = parts[0].split(':')[1];
    const base64Data = parts[1];
  
    // Decode the base64 data
    const binaryString = atob(base64Data);
    const buffer = new Buffer.from(binaryString, 'binary');
  
    return buffer
  }
