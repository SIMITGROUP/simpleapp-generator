/**
 * This file was automatically generated by simpleapp generator.
 * --remove-this-line-to-prevent-override--
 * last change 2025-03-16
 * author: Ks Tan
 */
 
// import {getAccessToken,getServerUrl} from '~/shared/liblogin'

export default defineEventHandler(async (event:any) => {
    const session = await requireUserSession(event)
    const req = event.node.req;
    try{        
        const accessToken = await getAccessToken(event,session)
        // console.log("accessTokenaccessToken",accessToken)        
        return new Promise<any>(async(resolve, reject)=>{
            // const result = {myname: 'this is me',myres:'hello'}

            const serverurl = getServerUrl()
            const xOrg = event.context.params?.xorg ?? ''
            const documentLink = event.context.params?._ ?? ''            
            const apiurl = serverurl +'/profile'
            // console.log("documentLink",documentLink)
            // console.log("Call backend url",apiurl)
            // console.log('context',event.context)
            try{
                
                const method = req.method.toLowerCase()
                let body :any= null
                if(['put','post','patch'].includes(method)){
                    body = await readBody(event);
                }
                const result = await $fetch(apiurl,{
                    method:method,
                    headers:{
                        'authorization': `Bearer ${accessToken}`,                        
                    },
                    body:body
                })
                // console.log("result")
                resolve(result)   
            }catch(err){
                reject(err)
            }
            
        })
    }catch(error){        
        throw createError({
            statusCode: 401,
            message: 'Unauthorised access without valid security token',
            data: error
          })
    }
    
    
})  



