<template>
  <div class="w-full">
    <div v-if="waiting" class="p-4 text-center">waiting..</div>
    <div v-else class="w-full p-2 grid grid-cols-1 md:grid-cols-3 gap-4">
      <LazyTenantCreator v-model:model-value="visibleCreateTenant" />

      <div
        v-for="tenant in alltenants"
        :key="tenant.id"
        :class="[
          'border rounded-lg p-4 relative',
          tenant.permissions[0]?.orgRecordId === currentOrgRecordId
            ? ' border-primary-500 shadow-lg'
            : ' border-gray-300',
        ]"
      >
        <div class="flex pb-4">
          <TextSubtitle
            :class="
              tenant.permissions[0]?.orgRecordId === currentOrgRecordId
                ? 'text-primary-800 font-bold pl-4'
                : 'ml-4'
            "
          >
            {{ tenant.tenantName }}
          </TextSubtitle>
        </div>
        <hr class="pb-2" />
        <div
          v-for="item in tenant.permissions"
          :key="item.id"
          class="cursor-pointer p-2 rounded"
        >
          <NuxtLink
            @click="openPickGroupDialog(item)"
            class="w-full flex flex-col"
          >
            <TextMain class="text-sm mb-2">{{ item.branchName }}</TextMain>
            <div class="grid grid-cols-4 gap-1">
              <Tag
                severity="primary"
                v-for="groupname in item.groups"
                :key="groupname"
                class="cursor-pointer transition-colors duration-200 ease-in-out shadow hover:shadow-lg"
              >
                {{ t(groupname) }}
              </Tag>
            </div>
          </NuxtLink>
        </div>
      </div>
    </div>
    <PickGroupDialog ref="pickGroupDialogRef" :item="selectedItem" />
  </div>
</template>

<script setup lang="ts">
/**
 * This file was automatically generated by simpleapp generator during initialization. It is changable.
 * --remove-this-line-to-prevent-override--
 * last change 2025-03-16
 * author: Ks Tan
 */
import _ from "lodash";
import { UserTenantPermissionItem } from "~/types";
import PickGroupDialog from "~/components/dialog/PickGroupDialog.vue";

const waiting = ref(true);
const alltenants = ref();
const visibleCreateTenant = ref(false);
const selectedItem = ref<UserTenantPermissionItem>();
const currentOrgRecordId = getUserProfile().orgRecordId;

const loadAllTenants = async () => {
  waiting.value = false;
  alltenants.value = (await getProfileApi().getAllTenants()).data;
};

const getBranchlist = (tenant: any) => tenant.permissions;

const pickGroupDialogRef = ref<typeof PickGroupDialog>();

const openPickGroupDialog = (item: UserTenantPermissionItem) => {
  selectedItem.value = item;
  if (pickGroupDialogRef.value) {
    pickGroupDialogRef.value.visible = true;
  }
};

onNuxtReady(() => {
  loadAllTenants();
});
</script>
