import { Injectable, NestMiddleware, Scope,Inject } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';
// import * as jwt from 'nestjs-jwt'

import { UserProvider } from '../providers/UserProvider';
// import {KeycloakConfigService} from "../keycloak/keycloak.service"
@Injectable({scope: Scope.REQUEST})
export class TenantMiddleware implements NestMiddleware {

  constructor(@Inject('UserProvider') private userprovider: UserProvider) {
    
  }

  async use(req: Request, res: Response, next: NextFunction) {
    if (req.baseUrl == '/oauth2-redirect.html') {
      next();
      return;
    }
    if (!req.headers['authorization']) {
      return res.status(401).send('Undefine bearer token');
    }
    if (!req.headers['x-org']) {
      return res.status(401).send('undefine header string x-org');
    }
    const u = this.userprovider //UserProvider.getInstance();

    try {
      let tokenstr: string = req.headers['authorization'];
      tokenstr = tokenstr.replace('Bearer ', '');
      await u.setCurrentUserInfo(tokenstr,req.headers['x-org'].toString())
      // u.setXorg(req.headers['x-org'].toString());      
      // u.setUserToken(tokenstr);
      
      next();
    } catch {
      return res.status(401).send('Invalid x-org or user info');
    }
  }
}
